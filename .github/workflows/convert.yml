name: Mycon Verse (Debug Mode)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          mkdir -p playlist output logs
          echo "‚úÖ Environment ready"

      - name: Download Master.m3u
        run: |
          curl -L -o playlist/input.m3u "https://raw.githubusercontent.com/RJMBTS/Aupl/refs/heads/main/Master.m3u"
          echo "‚úÖ Downloaded playlist/input.m3u"
          ls -lh playlist

      - name: Convert selected channels
        run: |
          set +e
          USER_AGENT="plaYtv/7.1.3 (Linux;Android 13) ygx/69.1 ExoPlayerLib/824.0"
          MASTER_FILE="output/jaupl.m3u"
          echo "#EXTM3U" > "$MASTER_FILE"

          CHANNELS=("Zee_Telugu" "Zee_Cinemalu" "Maa_HD" "Maa_Movies" "Maa_Music" "ZEE_TELUGU_HD" "ZEE_CINEMALU_HD")
          echo "üéØ Target channels: ${CHANNELS[@]}"

          COUNT=0
          while IFS= read -r line; do
            if [[ $line == http* ]]; then
              URL=$(echo "$line" | cut -d'|' -f1)
              COOKIE=$(echo "$line" | grep -oP 'cookie=\K[^|]+')
              KEY_PAIR=$(grep -A3 "$URL" playlist/input.m3u | grep -oP 'license_key=\K[^ ]+')
              CHANNEL=$(basename "$(dirname "$URL")")

              if [[ " ${CHANNELS[@]} " =~ " ${CHANNEL} " ]]; then
                CLEAN_NAME=$(echo "$CHANNEL" | sed 's/_BTS//')
                LOG_FILE="logs/${CLEAN_NAME}.log"
                OUT_FILE="output/${CLEAN_NAME}.m3u8"
                COUNT=$((COUNT+1))
                echo "‚ñ∂Ô∏è $CLEAN_NAME" | tee -a "$LOG_FILE"
                echo "URL: $URL" | tee -a "$LOG_FILE"
                echo "COOKIE: ${COOKIE:0:20}..." | tee -a "$LOG_FILE"
                echo "KEY_PAIR: ${KEY_PAIR}" | tee -a "$LOG_FILE"

                if [ -n "$KEY_PAIR" ]; then
                  ffmpeg -hide_banner -y \
                    -headers "user-agent: $USER_AGENT" \
                    -headers "cookie: $COOKIE" \
                    -decryption_key "${KEY_PAIR#*:}" \
                    -i "$URL" -c copy -f hls "$OUT_FILE" >>"$LOG_FILE" 2>&1
                else
                  ffmpeg -hide_banner -y \
                    -headers "user-agent: $USER_AGENT" \
                    -headers "cookie: $COOKIE" \
                    -i "$URL" -c copy -f hls "$OUT_FILE" >>"$LOG_FILE" 2>&1
                fi

                if [ -s "$OUT_FILE" ]; then
                  echo "‚úÖ Success: $CLEAN_NAME"
                  echo "#EXTINF:-1,${CLEAN_NAME}" >> "$MASTER_FILE"
                  echo "https://nrtv-one.vercel.app/${CLEAN_NAME}.m3u8" >> "$MASTER_FILE"
                else
                  echo "‚ùå Failed: $CLEAN_NAME (see $LOG_FILE)"
                fi
              fi
            fi
          done < playlist/input.m3u

          if [ $COUNT -eq 0 ]; then
            echo "‚ö†Ô∏è No channels matched or no valid URLs found" | tee logs/empty.log
          fi

      - name: Commit results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add output/*.m3u8 output/jaupl.m3u logs/*.log || true
          git commit -m "Mycon Verse debug update [skip ci]" || true
          git pull --rebase || true
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main || true
