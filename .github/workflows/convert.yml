name: Auto Convert JioTV Playlist to M3U8 Files

on:
  schedule:
    - cron: "*/30 * * * *"   # Runs every 30 minutes
  workflow_dispatch:          # Allow manual run

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install FFmpeg & curl
        run: sudo apt install -y ffmpeg curl

      - name: Fetch latest playlist from RJMBTS/Aupl
        run: |
          mkdir -p playlist
          curl -L -o playlist/input.m3u "https://raw.githubusercontent.com/RJMBTS/Aupl/refs/heads/main/Master.m3u"
          echo "‚úÖ Fetched Master.m3u from RJMBTS/Aupl"

      - name: Convert each channel to M3U8
        run: |
          set +e  # don't stop on error
          mkdir -p output logs
          USER_AGENT="plaYtv/7.1.3 (Linux;Android 13) ygx/69.1 ExoPlayerLib/824.0"
          MASTER_FILE="output/jaupl.m3u"
          FAILED_FILE="logs/failed.txt"

          echo "#EXTM3U" > "$MASTER_FILE"
          echo "" > "$FAILED_FILE"

          while IFS= read -r line; do
            if [[ $line == http* ]]; then
              URL=$(echo "$line" | cut -d'|' -f1)
              COOKIE=$(echo "$line" | grep -oP 'cookie=\K[^|]+')
              KEY_PAIR=$(echo "$line" | grep -oP 'key=\K[^|]+')
              CHANNEL=$(basename "$(dirname "$URL")")

              echo "üé¨ Processing: $CHANNEL"
              OUTPUT_FILE="output/${CHANNEL}.m3u8"

              ffmpeg -headers "user-agent: $USER_AGENT" \
                     -headers "cookie: $COOKIE" \
                     -decryption_key $(echo $KEY_PAIR | cut -d':' -f2) \
                     -i "$URL" \
                     -c copy -f hls "$OUTPUT_FILE"

              if [ $? -eq 0 ]; then
                echo "#EXTINF:-1,${CHANNEL}" >> "$MASTER_FILE"
                echo "https://<YOUR-VERCEL-DOMAIN>/output/${CHANNEL}.m3u8" >> "$MASTER_FILE"
                echo "‚úÖ $CHANNEL converted successfully"
              else
                TS=$(date '+%Y-%m-%d %H:%M:%S')
                echo "‚ö†Ô∏è Failed: $CHANNEL"
                echo "[$TS] $CHANNEL | $URL" >> "$FAILED_FILE"
              fi
            fi
          done < playlist/input.m3u

          echo "‚úÖ Created jaupl.m3u master playlist"
          echo "üìÑ Failed channels saved to logs/failed.txt"

      - name: Commit and push generated files
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # Only add files if they exist
          git add -f output/jaupl.m3u 2>/dev/null || true
          git add -f logs/failed.txt 2>/dev/null || true
          find output -name "*.m3u8" -type f -exec git add -f {} \; 2>/dev/null || true

          git commit -m "Auto-update jaupl.m3u ($(date))" || echo "No new changes"
          git push || echo "‚ö†Ô∏è Push skipped (no changes)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
