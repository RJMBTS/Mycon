name: Mycon Verse

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:       # allows manual trigger

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download latest Master.m3u
        run: |
          mkdir -p playlist output
          curl -L -o playlist/input.m3u "https://raw.githubusercontent.com/RJMBTS/Aupl/refs/heads/main/Master.m3u"

      - name: Convert selected channels to .m3u8
        run: |
          set +e
          USER_AGENT='plaYtv/7.1.3 (Linux;Android 13) ygx/69.1 ExoPlayerLib/824.0'
          MASTER_FILE="output/jaupl.m3u"

          echo "#EXTM3U" > "$MASTER_FILE"
          CHANNELS=("Zee_Telugu" "Zee_Cinemalu" "Maa_HD" "Maa_Movies" "Maa_Music" "ZEE_TELUGU_HD" "ZEE_CINEMALU_HD")

          for ch in "${CHANNELS[@]}"; do
            grep -A5 "$ch" playlist/input.m3u > tmp.txt
            if grep -q "http" tmp.txt; then
              URL=$(grep "http" tmp.txt | head -n1 | cut -d'|' -f1)
              COOKIE=$(grep -oP 'cookie=\K[^|]+' tmp.txt)
              CHANNEL=$(basename "$(dirname "$URL")" | sed 's/_BTS//')
              echo "üé¨ Converting $CHANNEL"

              OUTPUT_FILE="output/${CHANNEL}.m3u8"

              ffmpeg -headers "user-agent: $USER_AGENT" \
                     -headers "cookie: $COOKIE" \
                     -i "$URL" \
                     -c copy -f hls "$OUTPUT_FILE" -y

              if [ $? -eq 0 ] && [ -s "$OUTPUT_FILE" ]; then
                echo "#EXTINF:-1,$CHANNEL" >> "$MASTER_FILE"
                echo "https://nrtv-one.vercel.app/${CHANNEL}.m3u8" >> "$MASTER_FILE"
                echo "‚úÖ Updated $CHANNEL"
              else
                echo "‚ö†Ô∏è Skipped $CHANNEL"
              fi
            fi
          done

          echo "‚úÖ Created jaupl.m3u"
          set -e

      - name: Commit and push updates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Ignore local playlist updates
          git restore playlist/input.m3u || true

          git fetch origin main
          git checkout main
          git pull origin main --rebase || true

          git add output/*.m3u8 output/jaupl.m3u || echo "No files to add"
          git diff --cached --quiet || git commit -m "Mycon Verse hourly auto-update [skip ci]"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
