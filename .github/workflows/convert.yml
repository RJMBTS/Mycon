name: Mycon Verse Convert

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # every 6 hours

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ffmpeg

      - name: Create folders
        run: mkdir -p playlist output logs

      - name: Repack DASH to HLS (.m3u8)
        run: |
          echo "üé¨ Starting repack from .mpd to .m3u8"

          USER_AGENT="Mozilla/5.0"
          URL="https://d1g8wgjurz8via.cloudfront.net/bpk-tv/Zeetelgu/default/manifest.mpd"
          KEY="657fc8e7d533456cb0644fe03458a4b2"
          OUTPUT_FILE="output/Zee_Telugu_HD.m3u8"

          echo "‚û°Ô∏è URL: $URL"
          echo "‚û°Ô∏è Using decryption key: $KEY"

          # Repack .mpd (MPEG-DASH) to .m3u8 (HLS)
          ffmpeg \
            -headers "user-agent: ${USER_AGENT}" \
            -decryption_key ${KEY} \
            -i "${URL}" \
            -map 0:v:0 -map 0:a:0 \
            -c:v copy -c:a copy \
            -f hls \
            -hls_time 6 \
            -hls_playlist_type vod \
            -hls_segment_filename "output/Zee_Telugu_HD_%03d.ts" \
            "$OUTPUT_FILE" \
            -loglevel info > logs/ffmpeg_repack.log 2>&1 || true

          echo "‚úÖ Checking output..."
          if [ -s "$OUTPUT_FILE" ]; then
            echo "‚úÖ HLS file created: $OUTPUT_FILE"
          else
            echo "‚ùå Conversion failed. Check logs/ffmpeg_repack.log for details."
          fi

      - name: Commit and push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add output/*.m3u8 output/*.ts logs/*.log || echo "No files to add"
          git commit -m "Repacked Zee Telugu HD to HLS (.m3u8) [skip ci]" || echo "No changes to commit"

          git pull --rebase origin main || echo "No rebase needed"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main || echo "Push skipped"
