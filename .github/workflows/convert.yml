name: Mycon verse

on:
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours
  workflow_dispatch:        # Manual run option

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download latest Master.m3u
        run: |
          mkdir -p playlist output
          curl -L -o playlist/input.m3u "https://raw.githubusercontent.com/RJMBTS/Aupl/refs/heads/main/Master.m3u"
          cp playlist/input.m3u output/jaupl.m3u

      - name: Convert channels to .m3u8
        run: |
          set +e  # Don't stop on errors
          USER_AGENT='plaYtv/7.1.3 (Linux;Android 13) ygx/69.1 ExoPlayerLib/824.0'
          MASTER_FILE="output/jaupl.m3u"

          echo "#EXTM3U" > "$MASTER_FILE"

          while IFS= read -r line; do
            if [[ $line == http* ]]; then
              URL=$(echo "$line" | cut -d'|' -f1)
              COOKIE=$(echo "$line" | grep -oP 'cookie=\K[^|]+')
              KEY_PAIR=$(echo "$line" | grep -oP 'key=\K[^|]+')
              CHANNEL=$(basename "$(dirname "$URL")")
              CLEAN_NAME=$(echo "$CHANNEL" | sed 's/_BTS//')

              echo "ðŸŽ¬ Processing: $CLEAN_NAME"
              OUTPUT_FILE="output/${CLEAN_NAME}.m3u8"

              ffmpeg -headers "user-agent: $USER_AGENT" \
                     -headers "cookie: $COOKIE" \
                     -decryption_key $(echo $KEY_PAIR | cut -d':' -f2) \
                     -i "$URL" \
                     -c copy -f hls "$OUTPUT_FILE"
              
              if [ $? -eq 0 ]; then
                echo "âœ… Success: $CLEAN_NAME"
              else
                echo "âš ï¸ Skipped $CLEAN_NAME (conversion error)"
              fi

              echo "#EXTINF:-1,${CLEAN_NAME}" >> "$MASTER_FILE"
              echo "https://jiostar.vercel.app/${CLEAN_NAME}.m3u8" >> "$MASTER_FILE"
            fi
          done < playlist/input.m3u

          echo "âœ… Created jaupl.m3u master playlist"
          set -e

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add output/*.m3u8 output/jaupl.m3u || echo "No files to add"
          git commit -m "Auto update converted m3u8 files [skip ci]" || echo "No changes to commit"
          git push
