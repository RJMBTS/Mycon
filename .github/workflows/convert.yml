name: Mycon Verse (Debug)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Download latest Master.m3u
        run: |
          mkdir -p playlist output
          curl -L -o playlist/input.m3u "https://raw.githubusercontent.com/RJMBTS/Aupl/refs/heads/main/Master.m3u"
          echo "‚úÖ Downloaded latest Master.m3u"

      - name: Convert Telugu Channels (Debug)
        run: |
          set +e
          USER_AGENT='plaYtv/7.1.3 (Linux;Android 13) ygx/69.1 ExoPlayerLib/824.0'
          MASTER_FILE="output/jaupl.m3u"
          mkdir -p output
          echo "#EXTM3U" > "$MASTER_FILE"

          declare -A CHANNELS=(
            ["Zee_Telugu_HD_BTS"]="Zee_Telugu_HD"
            ["Zee_Cinemalu_HD_BTS"]="Zee_Cinemalu_HD"
            ["Maa_HD_BTS"]="Star_Maa_HD"
            ["Maa_Movies_BTS"]="Star_Maa_Movies_HD"
            ["Maa_Music_BTS"]="Star_Maa_Music"
          )

          for ID in "${!CHANNELS[@]}"; do
            CH_NAME="${CHANNELS[$ID]}"
            echo "üé¨ Checking: $CH_NAME ($ID)"

            URL=$(grep -o "https.*${ID}/output/index\.mpd[^ ]*" playlist/input.m3u | head -n 1)
            COOKIE=$(grep -A4 "${ID}" playlist/input.m3u | grep -oP 'cookie":"\K[^"]+' | head -n 1)
            KEY_PAIR=$(grep -A4 "${ID}" playlist/input.m3u | grep -oP 'license_key=\K[^:]+:[0-9a-f]+' | head -n 1)

            echo "‚û°Ô∏è URL: $URL"
            echo "‚û°Ô∏è COOKIE: $COOKIE"
            echo "‚û°Ô∏è KEY_PAIR: $KEY_PAIR"

            if [ -n "$URL" ]; then
              OUTPUT_FILE="output/${CH_NAME}.m3u8"
              echo "‚û°Ô∏è Processing $CH_NAME"
              
              if [ -n "$KEY_PAIR" ]; then
                DECRYPT_KEY=$(echo "$KEY_PAIR" | cut -d':' -f2)
                ffmpeg -headers "user-agent: $USER_AGENT" \
                       -headers "cookie: $COOKIE" \
                       -decryption_key "$DECRYPT_KEY" \
                       -i "$URL" \
                       -c copy -f hls "$OUTPUT_FILE" -y
              else
                ffmpeg -headers "user-agent: $USER_AGENT" \
                       -headers "cookie: $COOKIE" \
                       -i "$URL" \
                       -c copy -f hls "$OUTPUT_FILE" -y
              fi

              if [ $? -eq 0 ] && [ -s "$OUTPUT_FILE" ]; then
                echo "‚úÖ Success: $CH_NAME"
                echo "#EXTINF:-1,$CH_NAME" >> "$MASTER_FILE"
                echo "https://nrtv-one.vercel.app/output/${CH_NAME}.m3u8" >> "$MASTER_FILE"
              else
                echo "‚ö†Ô∏è Skipped $CH_NAME (conversion error)"
                rm -f "$OUTPUT_FILE"
              fi
            else
              echo "‚ùå No URL found for $CH_NAME"
            fi
          done

          echo "‚úÖ Finished debug run. Check logs above."
          set -e

      - name: Commit and push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git reset --hard
          git pull origin main --rebase || true
          git add output/*.m3u8 output/jaupl.m3u || echo "No files to add"
          git commit -m "Mycon Verse debug run [skip ci]" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
