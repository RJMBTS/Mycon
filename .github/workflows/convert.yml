name: Mycon Verse

on:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Prepare folders and download Master.m3u
        run: |
          mkdir -p playlist output
          curl -L -o playlist/input.m3u "https://raw.githubusercontent.com/RJMBTS/Aupl/main/Master.m3u"

      - name: Convert selected channels
        run: |
          set +e
          USER_AGENT="plaYtv/7.1.5 (Linux;Android 15) ExoPlayerLib/2.11.6 YGX/69.69.69.69"
          MASTER_FILE="output/jaupl.m3u"

          echo "#EXTM3U" > "$MASTER_FILE"

          CHANNELS=("Zee_Telugu" "Zee_Cinemalu" "ZEE_TELUGU_HD" "ZEE_CINEMALU_HD" "Maa_HD" "Maa_Movies" "Maa_Music")

          # Extract and process each channel block
          awk '/#EXTINF/{f=1; filename="block_"++i".txt"} f{print>filename} /index.mpd/{f=0}' playlist/input.m3u

          for block in block_*.txt; do
            URL=$(grep -Eo 'https://[^ ]+index\.mpd[^ ]*' "$block" | head -1)
            COOKIE=$(grep -Eo '"cookie":"[^"]+"' "$block" | cut -d':' -f2- | tr -d '"')
            KEY_PAIR=$(grep -Eo 'license_key=[^"]+' "$block" | cut -d'=' -f2)
            CHANNEL=$(basename "$(dirname "$URL")" | sed 's/_BTS//')

            if [[ " ${CHANNELS[@]} " =~ " ${CHANNEL} " ]]; then
              echo "ðŸŽ¬ Converting: $CHANNEL"
              OUTPUT_FILE="output/${CHANNEL}.m3u8"

              ffmpeg -headers "user-agent: $USER_AGENT" \
                     -headers "cookie: $COOKIE" \
                     -decryption_key "$(echo $KEY_PAIR | cut -d':' -f2)" \
                     -i "$URL" \
                     -c copy -f hls "$OUTPUT_FILE"

              if [ $? -eq 0 ] && [ -s "$OUTPUT_FILE" ]; then
                echo "âœ… Success: $CHANNEL"
                echo "#EXTINF:-1,${CHANNEL}" >> "$MASTER_FILE"
                echo "https://nrtv-one.vercel.app/${CHANNEL}.m3u8" >> "$MASTER_FILE"
              else
                echo "âš ï¸ Skipped $CHANNEL (conversion error)"
                rm -f "$OUTPUT_FILE"
              fi
            fi
          done

          rm block_*.txt 2>/dev/null || true
          echo "âœ… Created jaupl.m3u with selected channels"
          set -e

      - name: Commit and push results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add output/*.m3u8 output/jaupl.m3u || echo "No files to add"
          git commit -m "Mycon Verse auto-update [skip ci]" || echo "No changes to commit"
          git pull --rebase
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
